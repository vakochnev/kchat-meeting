services:
  kchat-meeting:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PYPI_USERNAME: ${PYPI_USERNAME}
        PYPI_PASSWORD: ${PYPI_PASSWORD}
    image: kchat-meeting
    container_name: kchat-meeting
    restart: unless-stopped
    env_file: .env
    command: >
      bash -c "
      alembic upgrade head &&
      python3 tools/seed_meeting_admins.py &&
      python3 main.py
      "
    volumes:
      - kchat-meeting-logs:/app/logs
    healthcheck:
      test: ["CMD", "python", "tools/bot_health_check.py", "-q"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s
    # Внешняя БД — DATABASE_URL указывает на хост вне Docker.
    # Для БД на том же хосте (Linux) добавьте:
    #   extra_hosts:
    #     - "host.docker.internal:host-gateway"
    #   DATABASE_URL=postgresql://user:pass@host.docker.internal:5432/meeting

volumes:
  kchat-meeting-logs:
