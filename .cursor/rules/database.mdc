---
description: Правила работы с базой данных
globs: "**/db/**/*.py"
alwaysApply: false
---

# База данных

## Конфигурация
- **Development**: SQLite (`sqlite:///meeting.db`)
- **Production**: PostgreSQL (`postgresql://...`)

## SQLAlchemy 2.0 стиль
```python
# ❌ ПЛОХО - устаревший стиль
session.query(MeetingResult).filter_by(user_id=user_id).all()

# ✅ ХОРОШО - SQLAlchemy 2.0
from sqlalchemy import select

stmt = select(MeetingResult).where(MeetingResult.user_id == user_id)
results = session.scalars(stmt).all()
```

## Управление сессиями
```python
# Всегда используем контекстный менеджер
from db import get_session

with get_session() as session:
    result = MeetingResult(user_id=123, metting_id="test")
    session.add(result)
    session.commit()
```

## Миграции (Alembic)
```bash
# Создать миграцию
alembic revision --autogenerate -m "описание"

# Применить
alembic upgrade head
```

## Модели - обязательные поля
```python
class BaseModel(Base):
    __abstract__ = True
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

## Индексы
Добавлять индексы на часто используемые поля для фильтрации:
```python
user_id = Column(Integer, nullable=False, index=True)
meeting_id = Column(String(100), nullable=False, index=True)
```
