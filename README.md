# KChat Meeting ‚Äî –ë–æ—Ç –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å–æ–≤–µ—â–∞–Ω–∏–π

–ë–æ—Ç –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Å–æ–≤–µ—â–∞–Ω–∏–π –≤ KChat. –°–æ–±–∏—Ä–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ SSE —Å–æ–±—ã—Ç–∏–π, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–ø—É—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç—ã –≤ –ë–î.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–≤–µ—â–∞–Ω–∏—è–º–∏:**
  - –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–∏–π
  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ø—É—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫ —Å–æ–≤–µ—â–∞–Ω–∏—é
  - –û–ø—Ä–æ—Å –æ –ø–ª–∞–Ω–∏—Ä—É–µ–º–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –≤ –ë–î

- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SSE:**
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Å–æ–±—ã—Ç–∏–π
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü—É `invited`

- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
  - SQLite / PostgreSQL
  - Alembic –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
  - –¢–∞–±–ª–∏—Ü–∞ `meeting_admins` ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã —Å–æ–±—Ä–∞–Ω–∏–π
  - –¢–∞–±–ª–∏—Ü–∞ `invited` ‚Äî —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö –∏ –æ—Ç–≤–µ—Ç—ã –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+
- [uv](https://github.com/astral-sh/uv) ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–∫–µ—Ç–æ–≤ Python

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ uv

```bash
# Linux/macOS
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd kchat-meeting
uv sync
```

> –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `messenger_bot_api` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ wheel –≤ `libs/`.

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env`:

```ini
BOT_TOKEN=your_bot_token_here
API_BASE_URL=https://api.kchat.app
SSE_BASE_URL=https://pusher.kchat.app
DATABASE_URL=sqlite:///meeting.db
LOG_LEVEL=INFO
```

### 4. –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```bash
uv run alembic upgrade head
uv run python scripts/seed_meeting_admins.py
```

### 5. –ó–∞–ø—É—Å–∫

```bash
uv run python main.py
```

## –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Docker

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker, Docker Compose
- –í–Ω–µ—à–Ω—è—è –ë–î (PostgreSQL) ‚Äî —É–∫–∞–∂–∏—Ç–µ `DATABASE_URL`

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `.env`

```ini
BOT_TOKEN=your_bot_token_here
DATABASE_URL=postgresql://user:password@host:5432/meeting
API_BASE_URL=https://api.kchat.app
SSE_BASE_URL=https://pusher.kchat.app
```

–î–ª—è –ë–î –Ω–∞ —Ç–æ–º –∂–µ —Ö–æ—Å—Ç–µ (Linux) –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `host.docker.internal` –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ `docker-compose.yml`:

```yaml
extra_hosts:
  - "host.docker.internal:host-gateway"
```

### 2. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```ini
# –°–ø–∏—Å–æ–∫ email —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π
MEETING_ADMINS=admin1@company.ru;admin2@company.ru

# –ò–ª–∏ —Å –§–ò–û: full_name|email
MEETING_ADMINS=–ò–≤–∞–Ω–æ–≤ –ò.–ò.|admin1@company.ru;–ü–µ—Ç—Ä–æ–≤ –ü.–ü.|admin2@company.ru

# –õ–∏–±–æ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É (—Ñ–æ—Ä–º–∞—Ç: –§–ò–û | email | phone)
MEETING_ADMINS_FILE=/app/config/meeting_admins.txt
```

### 3. –ó–∞–ø—É—Å–∫

```bash
docker compose up -d --build
```

–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è: –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic ‚Üí seed `meeting_admins` ‚Üí –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞.

### 4. –õ–æ–≥–∏ –≤ —Ñ–∞–π–ª

```ini
LOG_FILE=/app/logs/bot.log
```

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ volume `kchat-meeting-logs`.

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------------|----------|
| `BOT_TOKEN` | –î–∞ | –¢–æ–∫–µ–Ω –±–æ—Ç–∞ KChat |
| `DATABASE_URL` | –ù–µ—Ç | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `sqlite:///meeting.db`) |
| `API_BASE_URL` | –ù–µ—Ç | URL API KChat (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `https://api.kchat.app`) |
| `SSE_BASE_URL` | –ù–µ—Ç | URL SSE (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `https://pusher.kchat.app`) |
| `LOG_LEVEL` | –ù–µ—Ç | –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–æ–≤ (INFO, DEBUG –∏ —Ç.–¥.) |
| `LOG_FILE` | –ù–µ—Ç | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –ª–æ–≥–æ–≤ |
| `MEETING_ADMINS` | –ù–µ—Ç | –°–ø–∏—Å–æ–∫ email –∞–¥–º–∏–Ω–æ–≤ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ |
| `MEETING_ADMINS_FILE` | –ù–µ—Ç | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–¥–º–∏–Ω–æ–≤ |
| `HEALTH_CHECK_GROUP_ID` | –î–∞* | ID –≥—Ä—É–ø–ø—ã –¥–ª—è health check |
| `HEALTH_CHECK_WORKSPACE_ID` | –ù–µ—Ç | ID workspace (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -1) |
| `HEALTH_CHECK_TIMEOUT` | –ù–µ—Ç | –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —ç—Ö–æ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10) |

*–î–ª—è health check –Ω—É–∂–µ–Ω HEALTH_CHECK_GROUP_ID.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–∑–Ω–∏ –±–æ—Ç–∞ (Health Check)

–°–∫—Ä–∏–ø—Ç `tools/bot_health_check.py` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –∏ –æ–∂–∏–¥–∞–µ—Ç —ç—Ö–æ. –í—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ—Ä—ë—Ç—Å—è –∏–∑ `.env`:

```ini
BOT_TOKEN=...
API_BASE_URL=https://api.kchat.app
SSE_BASE_URL=https://pusher.kchat.app
HEALTH_CHECK_GROUP_ID=123
HEALTH_CHECK_TIMEOUT=10
```

**–ü—Ä–∏–º–µ—Ä—ã:**

```bash
uv run python tools/bot_health_check.py
uv run python tools/bot_health_check.py -v    # –ø–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥
uv run python tools/bot_health_check.py -q    # —Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º –¥–ª—è cron/Docker
```

**–ö–æ–¥—ã –≤–æ–∑–≤—Ä–∞—Ç–∞:** 0 ‚Äî OK, 1 ‚Äî –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, 2 ‚Äî –æ—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
kchat-meeting/
‚îú‚îÄ‚îÄ api/                    # API KChat (–ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ meeting/            # JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–æ–≤–µ—â–∞–Ω–∏–π
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ models.py          # –ú–æ–¥–µ–ª–∏ SQLAlchemy
‚îÇ   ‚îú‚îÄ‚îÄ session.py         # –°–µ—Å—Å–∏—è –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ storage.py         # –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
‚îú‚îÄ‚îÄ libs/                   # messenger_bot_api (–ª–æ–∫–∞–ª—å–Ω—ã–π wheel)
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ core/               # –Ø–¥—Ä–æ –±–æ—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.py         # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sse_handler.py  # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ SSE
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ health_check_responder.py  # –≠—Ö–æ –¥–ª—è tools/bot_health_check.py
‚îÇ   ‚îú‚îÄ‚îÄ meeting/            # –õ–æ–≥–∏–∫–∞ —Å–æ–≤–µ—â–∞–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handler.py     # –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ service.py     # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config_manager.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ answers/            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–∏–ø–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ seed_meeting_admins.py  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è meeting_admins
‚îú‚îÄ‚îÄ tools/
‚îÇ   ‚îî‚îÄ‚îÄ bot_health_check.py  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–∑–Ω–∏ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ alembic/                # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îú‚îÄ‚îÄ config.py               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ main.py                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ Dockerfile
‚îî‚îÄ‚îÄ docker-compose.yml
```

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `/start` | –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã |
| `/–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è`, `/meeting` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±—Ä–∞–Ω–∏–∏ |
| `/—É—á–∞—Å—Ç–∏–µ` | –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏ |
| `/–ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ` | –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö |
| `/—Å–æ–±—Ä–∞–Ω–∏–µ` | –ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—Ä–∞–Ω–∏–µ–º |
| `/—Å–æ–∑–¥–∞—Ç—å_—Å–æ–±—Ä–∞–Ω–∏–µ`, `/create_meeting` | –°–æ–∑–¥–∞—Ç—å —Å–æ–±—Ä–∞–Ω–∏–µ |
| `/–æ—Ç–º–µ–Ω–∞`, `/cancel` | –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ |
| `/–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å`, `/skip` | –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —à–∞–≥ –≤ –¥–∏–∞–ª–æ–≥–µ |
| `/–ø–æ–º–æ—â—å`, `/help` | –°–ø—Ä–∞–≤–∫–∞ |

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–≤–µ—â–∞–Ω–∏–π

JSON-—Ñ–∞–π–ª `config/meeting.json` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞:

```json
{
  "messages": {
    "greeting": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\n\n–§–ò–û: {fio}",
    "welcome": "üìÖ –í—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω—ã –Ω–∞ —Å–æ–≤–µ—â–∞–Ω–∏–µ.\n\n–§–ò–û: {fio}\n\n–ü–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ª–∏ –≤—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å?",
    "not_allowed": "‚ùå –í—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–ø–∏—Å–∫–µ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö..."
  }
}
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
